# TABLE 的增删改查

以下是  **PostgreSQL 中表（TABLE）的增删改查（CRUD）完整示例**，结合实际场景和避坑提示：

## 前提：创建示例表

先创建一个用于演示的表  `students`，包含字段：

- `id`：主键（自增，唯一标识）
- `name`：姓名（必填，字符串）
- `age`：年龄（可选，整数）
- `gender`：性别（可选，M/F）

```sql
CREATE TABLE IF NOT EXISTS students (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 主键自增（PostgreSQL 语法）
    name VARCHAR(50) NOT NULL,  -- 姓名，必填，最长50字符
    age INT,  -- 年龄，可选（可空）
    gender CHAR(1)  -- 性别，M/F（单字符）
);
```

## 查看所有的 TABLE

### 方法一 直接使用 PostgreSQL 交互命令

先连接数据库

```bash
psql -U 用户名 -d 数据库名
```

| 命令           | 作用                                                                       |
| -------------- | -------------------------------------------------------------------------- |
| `\dt`          | 显示  **当前模式**（如  `public`）下的  **用户自定义表**（默认隐藏系统表） |
| `\dt *.*`      | 显示  **所有模式**（包括系统模式，如  `pg_catalog`）下的所有表             |
| `\dt 模式名.*` | 显示  **指定模式**（如  `myschema`）下的表                                 |
| `\dt+`         | 显示表的  **详细信息**（大小、所有者、存储参数等）                         |

### 方法二 使用 SQL

**显示当前数据库所有用户表**（排除视图、系统表）

```sql
SELECT table_name
FROM information_schema.tables
WHERE table_type = 'BASE TABLE';  -- 只查“基表”，排除视图（VIEW）
```

**显示特定模式（如  `public`）的表**：

```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'myschema'
  AND table_type = 'BASE TABLE';   -- 排除视图   -- 限定模式为 public
```

**显示所有模式（含系统模式）的表**：

```sql
SELECT table_schema, table_name    -- 同时显示模式和表名
FROM information_schema.tables
WHERE table_type = 'BASE TABLE';
```

---

在 PostgreSQL 中，表（TABLE）的  **新增、查看、修改、删除**  主要针对表的**结构**（而非表内数据），以下是详细操作示例和说明：

## 一、新增表（创建表）

通过  `CREATE TABLE`  命令创建新表，定义表名、字段、数据类型及约束。

### 语法：

```sql
CREATE TABLE [IF NOT EXISTS] 表名 (
  字段1 数据类型 [约束],
  字段2 数据类型 [约束],
  ...
  [表级约束，如主键、外键等]
);
```

### 示例：

创建一个  `products`  表（存储商品信息）：

```sql
-- 若表不存在则创建，包含id（主键自增）、name（商品名）、price（价格）、stock（库存）
CREATE TABLE IF NOT EXISTS products (
  id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 主键自增
  name VARCHAR(100) NOT NULL,  -- 商品名，非空，最长100字符
  price NUMERIC(10, 2) CHECK (price >= 0),  -- 价格，保留2位小数，必须≥0
  stock INT DEFAULT 0,  -- 库存，默认值0
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP  -- 创建时间，默认当前时间
);
```

### 关键参数：

- `IF NOT EXISTS`：避免表已存在时报错（安全操作）；
- `GENERATED BY DEFAULT AS IDENTITY`：PostgreSQL 自增主键语法（替代 MySQL 的  `AUTO_INCREMENT`）；
- 约束：`NOT NULL`（非空）、`CHECK`（条件校验）、`DEFAULT`（默认值）等。

## 二、查看表（表结构 / 信息）

查看表的结构（字段、类型、约束）或表的元信息（所属模式、所有者等）。

### 1. 查看表结构（字段详情）

- **`psql`  客户端命令**（简单直观）：

  ```bash
  \d 表名  -- 如 \d products，显示字段、类型、约束等
  \d+ 表名 -- 更详细（包括存储大小、所有者、表空间等）
  ```

- **SQL 查询系统表**（通用，适合脚本）：

```sql
-- 查看表的字段、类型、约束
SELECT
  column_name,  -- 字段名
  data_type,    -- 数据类型
  is_nullable,  -- 是否允许为空（YES/NO）
  column_default  -- 默认值
FROM information_schema.columns
WHERE table_name = 'products';  -- 表名小写（PostgreSQL默认不区分大小写）
```

### 2. 查看表的元信息（所属模式、所有者等）

```sql
-- 查看表的模式、所有者、创建时间
SELECT
  schemaname,  -- 所属模式
  tablename,   -- 表名
  tableowner,  -- 所有者
  creation_time  -- 创建时间
FROM pg_tables
WHERE tablename = 'products';
```

### 3. 查看数据库中所有表

参考前文「如何展示所有的 tables」，常用：

```sql
-- 查看当前数据库所有用户表（排除系统表）
SELECT schemaname, tablename FROM pg_tables
WHERE schemaname NOT IN ('pg_catalog', 'information_schema');
```

## 三、修改表（表结构）

通过  `ALTER TABLE`  命令修改表结构（如添加 / 删除字段、修改类型、重命名表等）。

### 1. 新增字段（添加列）

```sql
-- 给 products 表新增 "category" 字段（商品分类，非空）
ALTER TABLE products
ADD COLUMN IF NOT EXISTS category VARCHAR(50) NOT NULL DEFAULT 'other';
```

- `IF NOT EXISTS`：避免字段已存在时报错。

### 2. 修改字段（类型 / 约束）

```sql
-- ① 修改字段类型（将 price 从 NUMERIC(10,2) 改为 NUMERIC(12,2)）
ALTER TABLE products
ALTER COLUMN price TYPE NUMERIC(12, 2);

-- ② 修改字段约束（取消 name 的非空约束，允许为空）
ALTER TABLE products
ALTER COLUMN name DROP NOT NULL;

-- ③ 修改字段默认值（将 stock 默认值从 0 改为 10）
ALTER TABLE products
ALTER COLUMN stock SET DEFAULT 10;
```

### 3. 重命名字段

```sql
-- 将 "category" 字段重命名为 "product_category"
ALTER TABLE products
RENAME COLUMN category TO product_category;
```

### 4. 删除字段（谨慎！会丢失该字段所有数据）

```sql
-- 删除 "created_at" 字段
ALTER TABLE products
DROP COLUMN IF EXISTS created_at;
```

- `IF EXISTS`：避免字段不存在时报错。

### 5. 重命名表

```sql
-- 将 "products" 表重命名为 "goods"
ALTER TABLE products
RENAME TO goods;
```

### 6. 添加表级约束（如主键、外键）

```sql
-- 给表添加主键（若创建时未指定）
ALTER TABLE goods
ADD PRIMARY KEY (id);  -- 假设 id 字段已存在

-- 添加外键（关联到 "brands" 表的 "id" 字段）
ALTER TABLE goods
ADD CONSTRAINT fk_goods_brand
FOREIGN KEY (brand_id) REFERENCES brands(id);
```

## 四、删除表

通过  `DROP TABLE`  命令删除表（表结构和数据会被彻底删除，谨慎操作！）。

### 语法：

```sql
DROP TABLE [IF EXISTS] 表名 [CASCADE | RESTRICT];
```

### 示例：

```sql
-- ① 删除表（若表不存在则不报错）
DROP TABLE IF EXISTS goods;

-- ② 强制删除表及所有依赖它的对象（如引用它的视图、外键）
DROP TABLE IF EXISTS goods CASCADE;
```

### 关键参数：

- `IF EXISTS`：避免表不存在时报错；
- `CASCADE`：删除表的同时，自动删除所有依赖该表的对象（如视图、外键关联的表）；
- `RESTRICT`（默认）：若表被其他对象依赖，则拒绝删除（防止误删）。

## 总结

表的核心操作对应命令：

| 操作       | 命令               | 核心场景                           |
| ---------- | ------------------ | ---------------------------------- |
| 新增表     | `CREATE TABLE`     | 定义表结构、字段、约束             |
| 查看表     | `\d`  或系统表查询 | 查看字段、类型、约束、元信息       |
| 修改表结构 | `ALTER TABLE`      | 增删字段、修改类型 / 约束、重命名  |
| 删除表     | `DROP TABLE`       | 彻底删除表（含数据），注意依赖关系 |

操作前建议备份数据，尤其是修改和删除操作，避免不可逆的数据丢失！
