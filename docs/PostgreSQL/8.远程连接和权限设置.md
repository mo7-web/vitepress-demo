要通过本地客户端访问云服务器上的 PostgreSQL 15.13，需要完成**远程访问配置**、**用户权限管理**和**安全加固**三个核心步骤。以下是详细操作指南：

## 一、配置 PostgreSQL 允许远程访问

### 方法一：修改配置文件

默认情况下，PostgreSQL 只允许本地（`localhost`）访问，需要修改配置文件开放远程连接。

#### 1. 找到配置文件位置

PostgreSQL 的核心配置文件通常位于：

- **Debian/Ubuntu**：`/etc/postgresql/15/main/`
- **CentOS/RHEL**：`/var/lib/pgsql/15/data/`
- 可通过  `psql -c "SHOW config_file;"`  命令查询具体路径。

#### 2. 修改  `postgresql.conf`（允许监听远程连接）

编辑配置文件：

```bash
sudo vim /etc/postgresql/15/main/postgresql.conf  # 根据实际路径修改
```

找到  `listen_addresses`  配置项，将默认的  `localhost`  改为  `*`（允许所有 IP 访问），或指定具体的本地 IP（更安全）：

```ini
# 原始配置
# listen_addresses = 'localhost'

# 修改后
listen_addresses = '*'  # 允许所有IP连接（生产环境建议指定具体IP）
```

保存并退出。

#### 3. 修改  `pg_hba.conf`（配置客户端认证规则）

该文件控制哪些客户端可以连接、以及使用何种认证方式。编辑文件：

```bash
sudo vim /etc/postgresql/15/main/pg_hba.conf  # 根据实际路径修改
```

添加一条允许远程连接的规则（建议放在文件末尾），格式如下：

```ini
# 允许特定IP段（如192.168.1.0/24）的客户端通过密码连接所有数据库
host    all             all             192.168.1.0/24         md5

# 若需允许任意IP（不推荐，风险高）：
# host    all             all             0.0.0.0/0               md5
```

- 字段含义：`host`（TCP/IP 连接）、`数据库名`、`用户名`、`客户端IP段`、`认证方式`（`md5`  表示密码加密认证）。
- 安全建议：**严格限制 IP 段**（如仅允许你家的公网 IP），避免使用  `0.0.0.0/0`。

#### 4. 重启 PostgreSQL 服务

使配置生效：

```bash
# Debian/Ubuntu
sudo systemctl restart postgresql

# CentOS/RHEL
sudo systemctl restart postgresql-15
```

### 方法二 使用 Ningx 反向代理

可以使用 Nginx 作为 TCP 代理转发 PostgreSQL 连接，实现本地客户端通过 Nginx 间接访问远程 PostgreSQL 服务器。这种方式的优势在于：可以通过 Nginx 增加一层访问控制、SSL 终止、负载均衡（如果有多个 PostgreSQL 实例）等。
这样相当于在通过 Nginx 本地访问 PostgreSQL 了，无需修改配置文件。

> 但需要注意 Nginx 需支持 TCP 代理功能（需编译时启用  `--with-stream`  模块）。

#### 1. 确认 Nginx 支持 TCP 代理

```bash
nginx -V  # 查看编译参数，若包含 --with-stream 则支持
```

#### 2. 配置 Nginx 作为 PostgreSQL 代理

```nginx
# 全局配置中添加 stream 块（与 http 块同级）
stream {
    # 定义 PostgreSQL 服务器地址（远程 PostgreSQL 所在的服务器IP和端口）
    upstream postgres_server {
        server 127.0.0.1:5432;  # 替换为实际的 PostgreSQL 服务器IP:端口
    }

    # 配置代理监听端口（本地客户端将连接此端口）
    server {
        listen 17018;  # Nginx 监听的端口（可自定义，如 15432 避免与本地 PostgreSQL 冲突）
        proxy_pass postgres_server;  # 转发到上面定义的 upstream
        ssl_preread on;
        # proxy_connect_timeout 10s;   # 连接超时时间
        # proxy_timeout 300s;          # 代理超时时间（保持连接的超时）

        # 可选：限制仅允许特定客户端IP访问（增强安全性）
        # allow 192.168.1.0/24;  # 允许你家的局域网IP段
        # allow 203.0.113.5;     # 允许你家的公网IP
        # deny all;              # 拒绝其他所有IP
    }
}
```

## 二、创建用户、设置密码并分配权限

为远程访问创建专用用户（避免使用默认的  `postgres`  超级用户），并严格控制权限。

### 1. 登录云服务器的 PostgreSQL

```bash
sudo -u postgres psql  # 切换到postgres用户并登录
```

### 2. 创建远程访问用户并设置密码

```sql
-- 创建用户（例如：remote_user），并设置强密码
CREATE USER remote_user WITH PASSWORD 'YourStrongPassword123!';  -- 密码需包含大小写、数字、特殊字符
```

### 3. 授权用户访问特定数据库

假设你要访问的数据库是  `mydb`，授予必要权限：

```sql
-- 允许用户连接数据库
GRANT CONNECT ON DATABASE mydb TO remote_user;

-- 授予数据库中所有表的读写权限（根据需求调整，遵循最小权限原则）
GRANT USAGE ON SCHEMA public TO remote_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO remote_user;
```

- 安全建议：**仅授予必要权限**（例如只读用户只给  `SELECT`），避免滥用。

### 4. 退出数据库

```sql
\q
```

## 三、配置云服务器防火墙（关键安全步骤）

云服务器需要开放 PostgreSQL 默认端口 `5432`，但需严格限制来源 IP。
如果采用的 Nginx 代理，则开放 Nginx listen 端口

### 1. 查看本地公网 IP

在家的网络中，通过搜索引擎查询「我的 IP」，获取你家的公网 IP（例如  `203.0.113.5`）。

### 2. 配置云服务器防火墙

- **阿里云 / 腾讯云 / AWS**：在控制台的「安全组」中添加规则：
  - 端口：`5432`
  - 来源 IP：填写你家的公网 IP（如  `203.0.113.5/32`，`/32`  表示仅允许该单个 IP）
  - 协议：`TCP`
- **服务器本地防火墙（如 UFW）**：

```bash
# 允许特定IP访问5432端口
sudo ufw allow from 203.0.113.5 to any port 5432
sudo ufw reload
```

- 安全建议：**禁止向全网开放 5432 端口**，定期更新允许的 IP（若家的 IP 是动态的，需注意 IP 变化后重新配置）。

## 四、启用 SSL 加密连接（传输层安全）

为防止数据在传输过程中被窃听，需启用 SSL 加密。

### 1. 检查 PostgreSQL 是否支持 SSL

PostgreSQL 15 默认支持 SSL，可通过以下命令确认：

```bash
psql -c "SHOW ssl;"  # 输出 on 表示已启用，off 则需手动开启
```

### 2. 启用 SSL（若未开启）

编辑  `postgresql.conf`：

```ini
ssl = on  # 开启SSL
ssl_cert_file = 'server.crt'  # 服务器证书（默认已存在）
ssl_key_file = 'server.key'   # 服务器私钥（默认已存在）
```

重启服务使配置生效。

### 3. 客户端强制使用 SSL 连接

在本地客户端连接时，指定  `sslmode=require`  确保加密连接：

```bash
# 示例：用psql连接
psql "host=云服务器公网IP port=5432 dbname=mydb user=remote_user password=YourStrongPassword123! sslmode=require"


psql "host=127.0.0.1 port=5432 dbname=mydb user=mo7cc password=asdasd55555 sslmode=require"
```

## 五、本地客户端连接测试

### 1. 使用命令行工具（psql）

```bash
psql -h 云服务器公网IP -p 5432 -U remote_user -d mydb -W
```

- `-h`：云服务器公网 IP
- `-p`：端口（默认 5432，若修改过则需对应）
- `-U`：远程用户名（如  `remote_user`）
- `-d`：要连接的数据库名
- `-W`：强制输入密码

### 2. 使用图形化工具

#### DBeaver （首推）

https://blog.csdn.net/tennysonsky/article/details/122397486
https://dbeaver.io/download/

#### Beekeeper Studio

https://blog.csdn.net/horses/article/details/108964432

#### Navicat Premium Lite

https://www.navicat.com.cn/products

1. 打开 Navicat，点击「添加新服务器」。
2. 在「常规」选项卡填写名称（自定义，如「云服务器 PostgreSQL」）。
3. 在「连接」选项卡：
   - 主机名 / 地址：云服务器公网 IP
   - 端口：5432
   - 维护数据库：`mydb`
   - 用户名：`remote_user`
   - 密码：`YourStrongPassword123!`
4. 在「SSL」选项卡，设置「SSL 模式」为  `require`。
5. 点击「保存」，若配置正确则会成功连接。

## 六、安全加固补充建议

1. **修改默认端口**：将  `postgresql.conf`  中的  `port = 5432`  改为其他端口（如 15432），减少被扫描的风险。
2. **定期轮换密码**：通过  `ALTER USER remote_user WITH PASSWORD 'NewStrongPassword!';`  更新密码。
3. **禁用超级用户远程访问**：确保  `pg_hba.conf`  中没有允许  `postgres`  用户远程连接的规则。
4. **限制数据库操作权限**：根据实际需求授予权限（如只读、只写），避免使用  `GRANT ALL`。
5. **启用日志审计**：在  `postgresql.conf`  中开启连接日志，便于追踪异常访问：

```ini
log_connections = on    # 记录连接事件
log_disconnections = on # 记录断开连接事件
```

6. **定期更新 PostgreSQL**：保持版本为最新稳定版，修复已知安全漏洞。

通过以上步骤，即可安全地从本地客户端访问云服务器上的 PostgreSQL。核心原则是：**最小权限 + 严格 IP 限制 + 加密传输**，最大限度降低安全风险。

## 七、用户(角色)的增删改查

### 1. 创建用户（创建角色并赋予登录权限）

使用  `CREATE ROLE`  命令创建用户，基本语法：

```sql
-- 创建普通用户（带登录权限）
CREATE ROLE 用户名 WITH LOGIN PASSWORD '密码';

-- 示例：创建一个名为 testuser，密码为 123456 的用户
CREATE ROLE testuser WITH LOGIN PASSWORD '123456';
```

可以附加更多权限选项：

```sql
-- 创建具有创建数据库权限的用户
CREATE ROLE dbcreator WITH LOGIN PASSWORD '123456' CREATEDB;

-- 创建超级用户（谨慎使用）
CREATE ROLE superuser WITH LOGIN PASSWORD '123456' SUPERUSER;
```

### 2. 查询用户（角色）信息

查询所有用户（角色）：

```sql
-- 查看所有角色
SELECT rolname FROM pg_roles;

-- 查看当前登录用户
SELECT current_user;

-- 查看用户的详细信息（包括权限）
SELECT * FROM pg_roles WHERE rolname = '用户名';
```

### 3. 修改用户（角色）属性

使用  `ALTER ROLE`  命令修改用户信息：

```sql
-- 修改密码
ALTER ROLE 用户名 WITH PASSWORD '新密码';

-- 示例：修改 testuser 的密码为 654321
ALTER ROLE testuser WITH PASSWORD '654321';

-- 允许用户创建数据库
ALTER ROLE testuser CREATEDB;

-- 禁止用户登录（临时禁用）
ALTER ROLE testuser NOLOGIN;

-- 恢复用户登录权限
ALTER ROLE testuser LOGIN;
```

### 4. 删除用户（角色）

使用  `DROP ROLE`  命令删除用户：

```sql
-- 删除用户（需确保用户没有正在使用的资源，否则会失败）
DROP ROLE 用户名;

-- 示例：删除 testuser
DROP ROLE testuser;
```

如果删除失败（提示用户有依赖资源），可以先强制删除其拥有的数据库 / 表，或使用  `REASSIGN OWNED`  转移所有权后再删除：

```sql
-- 转移用户所有的对象给其他用户（如 postgres）
REASSIGN OWNED BY 待删除用户 TO postgres;

-- 然后删除用户
DROP ROLE 待删除用户;
```

### 常用用户权限控制补充

创建用户后，通常需要为其分配数据库权限：

```sql
-- 授予用户对某个数据库的所有权限
GRANT ALL PRIVILEGES ON DATABASE 数据库名 TO 用户名;

-- 授予用户对某个表的查询权限
GRANT SELECT ON 表名 TO 用户名;

-- 替换 schema_name 为实际的 schema 名称
GRANT USAGE ON SCHEMA schema_name TO mo7cc;

-- 允许用户在数据库中创建 schema（创建后自动拥有该 schema 的权限）
GRANT CREATE ON DATABASE mydb TO mo7cc;

-- 授予 SELECT 权限（仅允许查询）
GRANT SELECT ON TABLE myschema."user" TO mo7cc;

-- 授予所有操作权限（谨慎使用）
GRANT ALL PRIVILEGES ON TABLE myschema."user" TO mo7cc;

-- 对 schema 下所有现有表授权
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA myschema TO mo7cc;

-- （可选）对未来在该 schema 中创建的表自动授权
ALTER DEFAULT PRIVILEGES IN SCHEMA myschema GRANT ALL PRIVILEGES ON TABLES TO mo7cc;
```

通过以上命令，你可以完成 PostgreSQL 中用户的全生命周期管理。角色（用户）管理是数据库权限控制的基础，建议根据实际需求分配最小必要权限，避免过度授权。

## 连接命令

```sh
psql "host=127.0.0.1 port=5432 dbname=mydb user=mo7cc password=asdasd55555 sslmode=require"
```

PostgreSQL 中  `sslmode`  还有其他可选值，用于控制不同的 SSL 连接策略，常见的包括：

- `disable`：完全不使用 SSL，强制明文连接。
- `allow`：优先尝试非 SSL 连接，如果失败再尝试 SSL（不推荐，有安全风险）。
- `prefer`(默认值)：优先尝试 SSL 连接，如果服务器不支持，则降级为非 SSL（默认行为，兼顾兼容性和安全性）。
- `require`：必须使用 SSL 连接，不支持则失败（安全性较高，适合生产环境）。
- `verify-ca`/`verify-full`：不仅要求 SSL 连接，还会验证服务器的 SSL 证书合法性（最高安全级别，需配置证书）。
