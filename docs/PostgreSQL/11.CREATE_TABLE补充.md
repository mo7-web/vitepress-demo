# CREATE TABLE 补充概念

## 一、常用数据类型（PostgreSQL）

数据类型决定了列可以存储的数据种类（如文本、数字、日期等），常用类型如下：

### 1. 字符串类型（存储文本）

- **`VARCHAR(n)`**：可变长度字符串，`n`  表示最大长度（如  `VARCHAR(50)`  表示最长 50 个字符），超出会报错。  
   示例：`username VARCHAR(50)`（存储用户名，最长 50 字符）
- **`CHAR(n)`**：固定长度字符串，`n`  表示固定长度，不足会用空格填充（不常用，建议用  `VARCHAR`）。  
   示例：`gender CHAR(1)`（存储性别，固定 1 个字符，如 'M'/'F'）
- **`TEXT`**：无长度限制的字符串，适合存储长文本（如文章、备注）。  
   示例：`description TEXT`（存储商品详细描述）

### 2. 数值类型（存储数字）

- **`INT`/`INTEGER`**：4 字节整数，范围约 ±21 亿。  
   示例：`age INT`（存储年龄）
- **`BIGINT`**：8 字节整数，范围更大（适合大数值，如订单量）。  
   示例：`total_orders BIGINT`
- **`SMALLINT`**：2 字节整数，范围较小（±3 万，适合存储状态码等）。  
   示例：`status SMALLINT`（1 表示正常，0 表示禁用）
- **`DECIMAL(p,s)`/`NUMERIC(p,s)`**：精确小数，`p`  是总位数，`s`  是小数位数（适合金额等需精确计算的场景）。  
   示例：`price DECIMAL(10,2)`（最大 99999999.99，保留 2 位小数）
- **`FLOAT`/`REAL`**：单精度浮点数（约 6 位小数，精度较低）；`DOUBLE PRECISION`：双精度浮点数（约 15 位小数）。  
   示例：`weight FLOAT`（存储商品重量，允许一定精度损失）

### 3. 日期时间类型（存储时间）

- **`DATE`**：仅存储日期（年 - 月 - 日）。  
   示例：`birthday DATE`（存储生日）
- **`TIME`**：仅存储时间（时：分: 秒）。  
   示例：`checkin_time TIME`（存储签到时间）
- **`TIMESTAMP`**：存储日期 + 时间（带时区可选  `TIMESTAMPTZ`，自动转换时区）。  
   示例：`created_at TIMESTAMP`（存储记录创建时间，如  `2023-10-01 14:30:00`）
- **`INTERVAL`**：存储时间间隔（如 2 小时、3 天）。  
   示例：`valid_period INTERVAL`（存储优惠券有效期，如  `30 days`）

### 4. 布尔类型（存储真 / 假）

- **`BOOLEAN`**：只能存储  `TRUE`（真）、`FALSE`（假）或  `NULL`（未知）。  
   示例：`is_active BOOLEAN`（存储用户是否活跃，`TRUE`  表示活跃）

### 5. 特殊类型

- **`SERIAL`/`BIGSERIAL`**：自增整数（本质是整数 + 序列，PostgreSQL 特有，用于主键自增）。  
   示例：`user_id SERIAL PRIMARY KEY`（自动生成唯一 ID，从 1 开始递增）
- **`IDENTITY`**：SQL 标准的自增类型（PostgreSQL 10+ 支持，比  `SERIAL`  更规范）。  
   示例：`order_id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY`
- **`ENUM`**：枚举类型，限制列值只能是预定义的选项（适合状态、类型等固定值）。  
   示例：

```sql
CREATE TYPE order_status AS ENUM ('pending', 'completed', 'cancelled');
CREATE TABLE orders (status order_status); -- 只能存储这三个值
```

- **`JSON`/`JSONB`**：存储 JSON 格式数据（`JSONB`  支持索引，查询更快）。  
   示例：`ext_info JSONB`（存储用户额外信息，如  `{"hobby": ["reading", "sports"]}`）

## 二、常用约束（限制数据规则）

约束用于保证数据的完整性和一致性，常用约束如下：

### 1. `NOT NULL`（非空约束）

- 作用：限制列不能存储  `NULL`（空值），必须有值。
- 示例：`email VARCHAR(100) NOT NULL`（邮箱必须填写，不能空）

### 2. `UNIQUE`（唯一约束）

- 作用：限制列的值在全表中唯一（不能重复），但可以有  `NULL`（多个  `NULL`  不视为重复）。
- 示例：`username VARCHAR(50) UNIQUE`（用户名不能重复，确保唯一）

### 3. `PRIMARY KEY`（主键约束）

- 作用：等价于  `NOT NULL + UNIQUE`，用于唯一标识一行数据（一张表只能有一个主键）。
- 示例：`user_id SERIAL PRIMARY KEY`（用 user_id 唯一标识每个用户）

### 4. `FOREIGN KEY`（外键约束）

- 作用：关联另一张表的主键，保证数据的引用完整性（避免无效关联）。
- 示例：

```sql
CREATE TABLE orders (
order_id SERIAL PRIMARY KEY,
user_id INT,
-- 关联users表的user_id，确保订单必须属于存在的用户
FOREIGN KEY (user_id) REFERENCES users(user_id)
);
```

### 5. `CHECK`（检查约束）

- 作用：自定义条件限制，只有满足条件的值才能存入。
- 示例：`age INT CHECK (age > 0)`（年龄必须大于 0）；`price DECIMAL CHECK (price >= 0)`（价格不能为负）

### 6. `DEFAULT`（默认值约束）

- 作用：当插入数据时未指定该列值，自动使用默认值。
- 示例：`created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP`（未指定创建时间时，自动填入当前时间）

### 7. `EXCLUSION`（排除约束，高级）

- 作用：确保表中没有两行在指定列上满足特定条件（比  `UNIQUE`  更灵活）。
- 示例（禁止同一时间段的会议室预约冲突）：

```sql
CREATE TABLE room_booking (
room_id INT,
start_time TIMESTAMP,
end_time TIMESTAMP,
EXCLUDE USING gist (
    room_id WITH =,
    tsrange(start_time, end_time) WITH &&  -- 禁止时间范围重叠
)
);
```

## 忘记设置主键时，如何添加自增主键？

PostgreSQL 中 “自增主键” 通常通过  `SERIAL`  或  `IDENTITY`  实现（推荐  `IDENTITY`，PostgreSQL 10+ 支持，更标准）。若建表时未设置，可通过  `ALTER TABLE`  补充：

### 情况 1：表中暂无数据（最简单）

直接添加一个自增列并设为主键：

```sql
-- 方法 1：使用 IDENTITY（推荐）
ALTER TABLE your_table
  ADD COLUMN id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY;

-- 方法 2：使用 SERIAL（旧方式，本质是自增序列）
ALTER TABLE your_table
  ADD COLUMN id SERIAL PRIMARY KEY;
```

### 情况 2：表中已有数据

需先确保新增的主键列值唯一且非空，步骤如下：

```sql
-- 1. 添加一个可空的整数列
ALTER TABLE your_table ADD COLUMN id INT;

-- 2. 为已有数据填充唯一值（如从 1 开始自增）
UPDATE your_table SET id = row_number() OVER ();

-- 3. 设置列非空，并添加自增属性和主键约束
ALTER TABLE your_table
  ALTER COLUMN id SET NOT NULL,
  ALTER COLUMN id ADD GENERATED ALWAYS AS IDENTITY,  -- 自增
  ADD PRIMARY KEY (id);  -- 设为主键
```

### 关键说明

- `GENERATED ALWAYS AS IDENTITY`：是 SQL 标准语法，严格控制自增（不能手动插入值，除非加  `OVERRIDING SYSTEM VALUE`）。
- `SERIAL`：是 PostgreSQL 扩展，本质是创建一个序列（sequence）并绑定到列，允许手动插入值（可能破坏自增逻辑）。
- 主键必须满足：非空（`NOT NULL`）且唯一（`UNIQUE`），添加时需确保表中数据符合这两个条件。

## 示例

```sql
CREATE TABLE users (
    user_id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    country VARCHAR(50),
    age INT CHECK (age > 0)
);
```

## 总结

- **数据类型**：定义 “存什么格式的数据”（如  `VARCHAR`  存文本，`INT`  存整数）。
- **约束**：定义 “数据必须满足什么规则”（如  `NOT NULL`  不能空，`UNIQUE`  不能重复）。

这些是 SQL 表设计的基础，合理选择数据类型和约束能让表结构更规范、数据更可靠。
